# Guide to `sesync-ci/*-lesson` Repositories

The lessons held in individual repositories within the SESYNC-CI organization nonetheless share common files. The tree shown below shows files from the `lesson-style` repository that are merged into each lesson. Except for `README.md` and `docs/_config.yml`, these files shall **only** be modified in the `lesson-style` repository.

```
lesson-style.git
├── CONTRIBUTING.md
├── Makefile
├── README.md
├── bin/
│   ├── build_slides.R
│   └── build_slides.py
└── docs/
    ├── _includes/
    │   ├── body.html
    │   ├── head.html
    │   └── subst_content.html
    ├── _layouts/
    │   ├── archive.html
    │   ├── course.html
    │   ├── default.html
    │   ├── instructor.html
    │   └── slides.html
    ├── course/
    │   ├── archive.html
    │   └── index.md
    ├── css/
    │   ├── default.css
    │   ├── slideshow.css
    │   └── static.css
    ├── instructor/
    │   └── index.md
    ├── slides/
    │   └── index.md
    ├── _config.yml
    └── index.md
```

The content of each lesson shall be contained within all or some of the following files and folders:

```
*-lesson.git
├── README.md
├── worksheet*
├── handouts.Rproj
├── data/
└── docs/
    ├── _posts/
    ├── _slides/
    ├── _slides_pmd/
    ├── _slides_md/
    ├── _slides_Rmd/
    ├── images/
    └── _config.yml
```

Note that `README.md` and `docs/_config.yml` occur in both, and the template in `lesson-style` includes instructions on which to parts to modify in any `*-lesson` repository to avoid merge conflicts. For a lesson written in RMarkdown, place .Rmd files within `docs/_slides_Rmd`; knitted slides will be generated within `docs/_slides`. Likewise, slides to be processed by Pweave go in `docs/_slides_pmd`. If a lesson is written purely in Markdown, the slides shall reside in `_slides`, but a lesson that combines Markdown slides with processed slides shall include `_slides_md`. Data for the lesson goes in the `data` folder, which will be distributed as a handout to participants. Figures produced during build and external images go in `docs/images`, and archived versions of the lesson go in `docs/_posts`. Including a `handouts.Rproj` in the distributed handouts makes it convenient to start an R session with the appropriate working directory.

The Makefile includes targets for building and publishing lessons:
  - `make slides` to run the `bin/build_slides.*` scripts that populate `docs/_slides`
  - `make lesson` makes the slides and publishes to GitHub
  - `make archive $DATE` copies the lesson as generated by GitHub into the `docs/_posts` archive.

## Versioning and Releases

A lesson should be archived after any event in which it is presented&mdash;either in a workshop or à la carte setting. The archive is a built (i.e. processed into HTML) page copied into `docs/_posts`. Given a date for the post, the `archive` target in the Makefile will download from `docs/course/archive.html` from GitHub, non-course archives should be downloaded manually. There are two "versioning" variables to set in `docs/_config.yml` before archiving:

- `tag` refers to a release of the lesson, along with associated data and worksheets
- `styleurl` refers to a release of `lesson-style`

The corresponing releases must exist:
- The lesson's repository needs a release corresponding to `tag` that includes any data and worksheets in a `handouts.zip` "binary" attachement.
- After updating the `styleurl`, create the release in `lesson-style` before archiving any lessons

## Upstream

The repository `lesson-style` is intended to be upstream of all `*-lesson` repositories, but configuration as such must be achieved in a local clone (i.e. not on GitHub). Configure each `*-lesson` clone as follows:

```
git remote add upstream git@github.com:SESYNC-ci/lesson-style.git
git fetch upstream
git branch --track upstream upstream/master
```

To merge changes made within the `lesson-style` repository into a lesson, run `git merge upstream` from the master branch. The `upstream` branch may not have a shared history with the `master` branch; it is okay to use '--allow-unrelated-histories'.  Modifications to the upstream branch shall be meant for all lessons. A change to `docs/_layouts/default.html`, for example, should be commited to the upstream branch and pushed to the master branch of the upstream remote (i.e. to the `lesson-style` repository on GitHub):

```
git checkout upstream
git add docs/_layouts/default.html
git commit
git push
```

## Creating a **new** lesson

Create a new, public repository owned by the SESYNC-CI organization: use a short name, provide a description that can be exported as a human readable lesson title (e.g. on SESYNC's [lessons] tab), and do not include a README.

Locally clone `lesson-style` repository into a suitably named `*-lesson` folder, rename the branch and remote, and checkout a new master:

```
git clone git@github.com:SESYNC-ci/lesson-style.git %name%-lesson
cd %name%-lesson
git remote rename origin upstream
git branch -m master upstream
git checkout master
git remote add origin git@github.com:SESYNC-ci/%name%-lesson.git
git push -u origin master
```

Everythin above is standardized across lessons, the following is where the real work begins! First, go to the lesson repository's GitHub settings and select `master/docs` as the GitHub Pages source. Configure `README.md` by commiting the following to the `README.md` file, where `%name%` should be replaced with the new lesson's name.

```
[lesson]: https://sesync-ci.github.io/%name%-lesson
[slideshow]: https://sesync-ci.github.io/%name%-lesson/slides
```

Configure the lesson by setting the following variables in the `# Site` section of the `docs/_config.yml` YAML file.

- `title`: a lesson title
- `handouts`: the worksheet, or list of worksheets, distributed with the handouts
- `tag`: the release version associated with the `handouts.zip` attached to a release, if any
- `lesson`: the number of the lesson in a workshop setting
- `instructor`: who will give the lesson in a workshop setting
- `authors`: the list of contributors

Always create the `docs/_slides` folder, but develop content within one of the following folders as appropriate:

- `docs/_slides` for markdown (.md)
- `docs/_slides_Rmd` for RMarkdown (.Rmd)
- `docs/_slides_pmd` for Pweave (.pmd)

Each file within one of these folders becomes a vertical stack of slides in a [Reveal.js] presentation: use "===" on it's own line to indicate a slide break. Vertical stacks are concatenated horizontally in the order supplied by the `slide_sorter` array in `docs/_config.yml`.

[Reveal.js]: http://lab.hakim.se/reveal-js
[lessons]: http://www.sesync.org/for-you/cyberinfrastructure/training/%C3%A0-la-carte-lessons
